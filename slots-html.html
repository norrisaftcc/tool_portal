<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golden Fortune Slots - PULSE Play</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #0A0A1A;
            color: white;
            text-align: center;
            padding: 20px;
            background-image: radial-gradient(circle at center, #1a1a3a 0%, #0A0A1A 100%);
            margin: 0;
        }
        
        .casino-lights {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: repeating-linear-gradient(to right, #e74c3c, #f1c40f, #2ecc71, #3498db, #9b59b6);
            opacity: 0.7;
            animation: casino-lights 5s linear infinite;
        }
        
        @keyframes casino-lights {
            0% { background-position: 0 0; }
            100% { background-position: 100% 0; }
        }
        
        .game-container {
            max-width: 800px;
            margin: 40px auto 0;
            background: linear-gradient(145deg, #680000 0%, #8B0000 50%, #A00000 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            position: relative;
            border: 8px solid #D4AF37;
            overflow: hidden;
        }

        .portal-link {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 15px;
            border-radius: 30px;
            text-decoration: none;
            color: #D4AF37;
            font-weight: bold;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .portal-link:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.05);
        }

        .portal-link span {
            margin-left: 5px;
        }
        
        .machine-top {
            height: 40px;
            background: linear-gradient(to right, #D4AF37, #FFF8DC, #D4AF37);
            border-radius: 10px 10px 0 0;
            margin: -20px -20px 20px -20px;
            border-bottom: 3px solid #222;
            position: relative;
        }
        
        .machine-top::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 10px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px 10px 0 0;
        }
        
        h1 {
            margin-top: 0;
            text-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700;
            font-family: 'Impact', sans-serif;
            letter-spacing: 2px;
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #FFD700;
        }
        
        .slot-machine {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            background: #000;
            padding: 20px;
            border-radius: 10px;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.8);
            position: relative;
        }
        
        .payline-indicator {
            position: absolute;
            width: 100%;
            height: 5px;
            background-color: #FFD700;
            left: 0;
            z-index: 10;
            opacity: 0;
            box-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700;
            transition: opacity 0.3s;
        }

        .payline-1 { top: 30%; }
        .payline-2 { top: 50%; }
        .payline-3 { top: 70%; }
        
        .reel-container {
            position: relative;
            border: 4px solid #D4AF37;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 0 10px #000;
        }
        
        .reel {
            width: 120px;
            height: 360px; /* 3 symbols visible */
            background: linear-gradient(to bottom, #312e2e, #423f3e);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            overflow: hidden;
            position: relative;
        }
        
        .reel::before, .reel::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 120px;
            z-index: 2;
            pointer-events: none;
        }
        
        .reel::before {
            top: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.1) 100%);
        }
        
        .reel::after {
            bottom: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.1) 100%);
        }
        
        .symbols {
            position: absolute;
            transition: top 1.5s cubic-bezier(0.33, 1, 0.68, 1);
            top: 0;
        }
        
        .symbol {
            height: 120px;
            width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px dashed #444;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 0 20px;
        }
        
        .paylines-selector {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #222;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #D4AF37;
        }
        
        .paylines-selector button {
            margin: 5px 0;
            padding: 5px 10px;
            background: linear-gradient(to bottom, #4b6cb7, #182848);
            color: white;
            border: 1px solid #D4AF37;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }
        
        .paylines-selector button.active {
            background: linear-gradient(to bottom, #f83600, #fe8c00);
        }
        
        .spin-button-container {
            position: relative;
        }
        
        .spin-button {
            background: radial-gradient(circle, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 24px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3),
                        inset 0 -8px 0 rgba(0,0,0,0.3),
                        0 0 10px rgba(231, 76, 60, 0.8);
            width: 120px;
            height: 120px;
        }
        
        .spin-button:hover {
            transform: scale(1.05);
            box-shadow: 0 7px 20px rgba(0,0,0,0.4),
                        inset 0 -8px 0 rgba(0,0,0,0.3),
                        0 0 15px rgba(231, 76, 60, 1);
        }
        
        .spin-button:active {
            transform: translateY(5px) scale(0.95);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3),
                        inset 0 -4px 0 rgba(0,0,0,0.3);
        }
        
        .spin-button:disabled {
            background: radial-gradient(circle, #95a5a6 0%, #7f8c8d 100%);
            cursor: not-allowed;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2),
                        inset 0 -8px 0 rgba(0,0,0,0.2);
        }
        
        .credits-display {
            background: linear-gradient(to bottom, #333, #111);
            border: 3px solid #D4AF37;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 24px;
            font-family: 'Digital', monospace;
            position: relative;
            color: #32CD32;
            text-shadow: 0 0 5px rgba(50, 205, 50, 0.7);
            display: inline-block;
            min-width: 200px;
        }
        
        .credits-display::before {
            content: 'CREDITS';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: #111;
            padding: 0 10px;
            font-size: 14px;
            color: #FFD700;
            border-radius: 10px;
        }
        
        .bet-amount {
            font-size: 20px;
            background: #222;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #D4AF37;
        }
        
        .win-message {
            margin-top: 20px;
            font-size: 28px;
            height: 40px;
            color: #FFD700;
            text-shadow: 0 0 10px #FFD700;
            font-weight: bold;
            transition: transform 0.5s, opacity 0.5s;
        }
        
        .win-message.active {
            transform: scale(1.2);
            animation: pulse 0.5s infinite alternate;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; transform: scale(1.0); }
            100% { opacity: 1; transform: scale(1.2); }
        }
        
        .paytable {
            background: rgba(0,0,0,0.7);
            border: 2px solid #D4AF37;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-height: 150px;
            overflow-y: auto;
            text-align: left;
        }
        
        .paytable h3 {
            margin-top: 0;
            color: #FFD700;
            text-align: center;
            border-bottom: 1px solid #D4AF37;
            padding-bottom: 5px;
        }
        
        .paytable-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            border-bottom: 1px dotted #444;
            padding-bottom: 5px;
        }
        
        .paytable-symbols {
            display: flex;
            align-items: center;
        }
        
        .paytable-value {
            color: #FFD700;
            font-weight: bold;
        }
        
        .machine-handle {
            position: absolute;
            right: -40px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 200px;
            background: linear-gradient(to right, #D4AF37, #FFF8DC, #D4AF37);
            border-radius: 0 15px 15px 0;
            cursor: pointer;
            transition: transform 0.5s;
            transform-origin: top center;
        }
        
        .machine-handle::before {
            content: '';
            position: absolute;
            top: -30px;
            left: 0;
            width: 30px;
            height: 30px;
            background: #D4AF37;
            border-radius: 50%;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        
        .machine-handle::after {
            content: '';
            position: absolute;
            bottom: -30px;
            left: 0;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #FFF8DC, #D4AF37);
            border-radius: 50%;
            box-shadow: 0 5px 10px rgba(0,0,0,0.5);
            transform: translateX(-10px);
        }
        
        .machine-handle.pulled {
            transform: translateY(-50%) rotate(45deg);
        }
        
        .bonus-light {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #444;
            border: 2px solid #D4AF37;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }
        
        .bonus-light.active {
            background: #e74c3c;
            box-shadow: 0 0 10px #e74c3c, 0 0 20px #e74c3c;
            animation: blink 0.5s infinite alternate;
        }
        
        @keyframes blink {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Bonus game styles */
        .bonus-game {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        
        .bonus-game.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .bonus-content {
            background: #800000;
            border: 5px solid #D4AF37;
            border-radius: 15px;
            padding: 30px;
            max-width: 80%;
            text-align: center;
            box-shadow: 0 0 30px #D4AF37;
        }
        
        .bonus-title {
            color: #FFD700;
            font-size: 32px;
            margin-top: 0;
            text-shadow: 0 0 10px #FFD700;
        }
        
        .bonus-choices {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        
        .bonus-choice {
            width: 120px;
            height: 120px;
            background: #D4AF37;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            cursor: pointer;
            transition: transform 0.3s;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        
        .bonus-choice:hover {
            transform: scale(1.1);
        }
        
        .bonus-result {
            font-size: 24px;
            color: #FFD700;
            margin-bottom: 20px;
        }
        
        .close-bonus {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s;
        }
        
        .close-bonus:hover {
            background: #c0392b;
        }

        /* Slot machine lights for added realism */
        .slot-lights {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #FFD700;
            box-shadow: 0 0 10px #FFD700;
            animation: slot-lights 2s infinite alternate;
        }

        @keyframes slot-lights {
            0% { opacity: 0.3; }
            100% { opacity: 0.9; }
        }

        /* Position the lights around the border */
        .slot-light-1 { top: 10px; left: 10px; animation-delay: 0.1s; }
        .slot-light-2 { top: 10px; right: 10px; animation-delay: 0.2s; }
        .slot-light-3 { bottom: 10px; left: 10px; animation-delay: 0.3s; }
        .slot-light-4 { bottom: 10px; right: 10px; animation-delay: 0.4s; }
        .slot-light-5 { top: 10px; left: 33%; animation-delay: 0.5s; }
        .slot-light-6 { top: 10px; right: 33%; animation-delay: 0.6s; }
        .slot-light-7 { bottom: 10px; left: 33%; animation-delay: 0.7s; }
        .slot-light-8 { bottom: 10px; right: 33%; animation-delay: 0.8s; }
    </style>
</head>
<body>
    <div class="casino-lights"></div>
    
    <div class="game-container">
        <div class="machine-top"></div>
        <!-- Portal navigation is handled by the parent frame -->
        <div class="slot-light-1 slot-lights"></div>
        <div class="slot-light-2 slot-lights"></div>
        <div class="slot-light-3 slot-lights"></div>
        <div class="slot-light-4 slot-lights"></div>
        <div class="slot-light-5 slot-lights"></div>
        <div class="slot-light-6 slot-lights"></div>
        <div class="slot-light-7 slot-lights"></div>
        <div class="slot-light-8 slot-lights"></div>
        
        <h1>GOLDEN FORTUNE</h1>
        
        <div class="bonus-light" id="bonusLight"></div>
        
        <div class="slot-machine">
            <div class="payline-indicator payline-1"></div>
            <div class="payline-indicator payline-2"></div>
            <div class="payline-indicator payline-3"></div>
            
            <div class="reel-container">
                <div class="reel" id="reel1">
                    <div class="symbols" id="symbols1"></div>
                </div>
            </div>
            <div class="reel-container">
                <div class="reel" id="reel2">
                    <div class="symbols" id="symbols2"></div>
                </div>
            </div>
            <div class="reel-container">
                <div class="reel" id="reel3">
                    <div class="symbols" id="symbols3"></div>
                </div>
            </div>
        </div>
        
        <div class="win-message" id="winMessage"></div>
        
        <div class="controls">
            <div class="paylines-selector">
                <p>PAYLINES</p>
                <button class="payline-button active" data-paylines="1">1 LINE</button>
                <button class="payline-button" data-paylines="2">2 LINES</button>
                <button class="payline-button" data-paylines="3">3 LINES</button>
            </div>
            
            <div class="credits-display">
                <span id="credits">1000</span>
            </div>
            
            <div class="spin-button-container">
                <button class="spin-button" id="spinButton">SPIN</button>
            </div>
            
            <div class="bet-amount">
                <p>BET PER LINE</p>
                <button id="betDecrease">-</button>
                <span id="betAmount">5</span>
                <button id="betIncrease">+</button>
            </div>
        </div>
        
        <div class="paytable">
            <h3>PAYTABLE</h3>
            <div class="paytable-row">
                <div class="paytable-symbols">7️⃣ 7️⃣ 7️⃣</div>
                <div class="paytable-value">x15</div>
            </div>
            <div class="paytable-row">
                <div class="paytable-symbols">🍀 🍀 🍀</div>
                <div class="paytable-value">x12</div>
            </div>
            <div class="paytable-row">
                <div class="paytable-symbols">💎 💎 💎</div>
                <div class="paytable-value">x10</div>
            </div>
            <div class="paytable-row">
                <div class="paytable-symbols">🍉 🍉 🍉</div>
                <div class="paytable-value">x8</div>
            </div>
            <div class="paytable-row">
                <div class="paytable-symbols">🍊 🍊 🍊</div>
                <div class="paytable-value">x6</div>
            </div>
            <div class="paytable-row">
                <div class="paytable-symbols">🍇 🍇 🍇</div>
                <div class="paytable-value">x4</div>
            </div>
            <div class="paytable-row">
                <div class="paytable-symbols">🍋 🍋 🍋</div>
                <div class="paytable-value">x3</div>
            </div>
            <div class="paytable-row">
                <div class="paytable-symbols">🍒 🍒 🍒</div>
                <div class="paytable-value">x2</div>
            </div>
            <div class="paytable-row">
                <div class="paytable-symbols">⭐ Any position</div>
                <div class="paytable-value">BONUS GAME</div>
            </div>
            <div class="paytable-row">
                <div class="paytable-symbols">🔔 Wild Symbol</div>
                <div class="paytable-value">Substitutes Any</div>
            </div>
        </div>
        
        <div class="machine-handle" id="machineHandle"></div>
    </div>
    
    <div class="bonus-game" id="bonusGame">
        <div class="bonus-content">
            <h2 class="bonus-title">BONUS ROUND!</h2>
            <p>Choose a treasure chest to reveal your prize:</p>
            
            <div class="bonus-choices">
                <div class="bonus-choice" data-value="1">🎁</div>
                <div class="bonus-choice" data-value="2">🎁</div>
                <div class="bonus-choice" data-value="3">🎁</div>
            </div>
            
            <div class="bonus-result" id="bonusResult"></div>
            <button class="close-bonus" id="closeBonusButton" style="display:none;">COLLECT WINNINGS</button>
        </div>
    </div>

    <script>
        // Game configuration
        const symbols = ['🍒', '🍋', '🍇', '🍉', '🍊', '💎', '7️⃣', '🍀', '🔔', '⭐'];
        const reelLength = 30; // Number of symbols per reel
        const wildSymbol = '🔔';
        const bonusSymbol = '⭐';
        let baseBet = 5;
        let activePaylines = 1;
        
        // Game state
        let credits = 1000;
        let spinning = false;
        let bonusMode = false;
        let bonusLightActive = false;
        let winningLines = [];
        
        // DOM elements
        const spinButton = document.getElementById('spinButton');
        const creditsDisplay = document.getElementById('credits');
        const winMessage = document.getElementById('winMessage');
        const machineHandle = document.getElementById('machineHandle');
        const reels = [
            document.getElementById('symbols1'),
            document.getElementById('symbols2'),
            document.getElementById('symbols3')
        ];
        const paylineButtons = document.querySelectorAll('.payline-button');
        const paylineIndicators = document.querySelectorAll('.payline-indicator');
        const betAmountDisplay = document.getElementById('betAmount');
        const betDecreaseButton = document.getElementById('betDecrease');
        const betIncreaseButton = document.getElementById('betIncrease');
        const bonusLight = document.getElementById('bonusLight');
        const bonusGame = document.getElementById('bonusGame');
        const bonusChoices = document.querySelectorAll('.bonus-choice');
        const bonusResult = document.getElementById('bonusResult');
        const closeBonusButton = document.getElementById('closeBonusButton');
        
        // Initialize reels
        function initReels() {
            reels.forEach((reel, reelIndex) => {
                for (let i = 0; i < reelLength; i++) {
                    const symbol = document.createElement('div');
                    symbol.className = 'symbol';
                    
                    // Use weighted distribution
                    let symbolIndex;
                    const rand = Math.random();
                    
                    if (rand < 0.01 && reelIndex !== 0) {
                        // Bonus symbol (rare, not on first reel)
                        symbolIndex = symbols.indexOf(bonusSymbol);
                    } else if (rand < 0.05) {
                        // Wild symbol (rare)
                        symbolIndex = symbols.indexOf(wildSymbol);
                    } else if (rand < 0.35) {
                        // Common symbols (🍒, 🍋, 🍇)
                        symbolIndex = Math.floor(Math.random() * 3);
                    } else if (rand < 0.75) {
                        // Medium symbols (🍉, 🍊, 💎)
                        symbolIndex = 3 + Math.floor(Math.random() * 3);
                    } else {
                        // Rare symbols (7️⃣, 🍀)
                        symbolIndex = 6 + Math.floor(Math.random() * 2);
                    }
                    
                    symbol.textContent = symbols[symbolIndex];
                    reel.appendChild(symbol);
                }
                
                // Position the reel to show the middle
                reel.style.top = `-${(reelLength - 3) * 120}px`;
            });
        }
        
        // Get symbol positions for each payline
        function getPaylinePositions(reelPositions) {
            const paylines = [
                [1, 1, 1], // Middle line
                [0, 0, 0], // Top line
                [2, 2, 2]  // Bottom line
            ];
            
            // Calculate actual positions based on where reels stopped
            return paylines.slice(0, activePaylines).map(payline => {
                return payline.map((offset, reelIndex) => {
                    // Calculate the symbol index on each reel for this payline
                    const reelPosition = reelPositions[reelIndex];
                    const symbolIndex = (reelPosition + offset) % reelLength;
                    return symbolIndex;
                });
            });
        }
        
        // Highlight winning paylines
        function highlightPaylines(winningLines) {
            paylineIndicators.forEach((indicator, i) => {
                indicator.style.opacity = winningLines.includes(i) ? '1' : '0';
            });
        }
        
        // Get symbol at a specific position on a reel
        function getSymbolAt(reelIndex, symbolIndex) {
            const symbolElement = reels[reelIndex].children[symbolIndex];
            return symbolElement.textContent;
        }
        
        // Check for bonus symbols
        function checkForBonus(visibleSymbols) {
            // Flatten the 3x3 grid of visible symbols
            const allVisibleSymbols = visibleSymbols.flat();
            
            // Check if any bonus symbols are visible
            return allVisibleSymbols.some(symbol => symbol === bonusSymbol);
        }
        
        // Spin the reels
        function spin() {
            if (spinning || credits < baseBet * activePaylines) return;
            
            // Reset display
            highlightPaylines([]);
            winMessage.textContent = '';
            winMessage.classList.remove('active');
            winningLines = [];
            
            // Deduct credits
            const totalBet = baseBet * activePaylines;
            credits -= totalBet;
            creditsDisplay.textContent = credits;
            
            spinning = true;
            spinButton.disabled = true;
            
            // Pull the handle if user clicked the spin button
            if (!machineHandle.classList.contains('pulled')) {
                machineHandle.classList.add('pulled');
                setTimeout(() => {
                    machineHandle.classList.remove('pulled');
                }, 1000);
            }
            
            // Randomly determine where each reel will stop
            const stopPositions = reels.map(() => Math.floor(Math.random() * reelLength));
            
            // Stagger the spin and stop of each reel with realistic effects
            reels.forEach((reel, index) => {
                // Reset position for visual continuity
                reel.style.transition = 'none';
                reel.style.top = `-${(reelLength - 3) * 120}px`;
                
                // Force reflow
                void reel.offsetHeight;
                
                // Spin with increasing duration and easing for each reel
                const duration = 2 + index * 0.5;
                const extraSpins = index * 2; // Each subsequent reel spins more
                
                reel.style.transition = `top ${duration}s cubic-bezier(0.33, 1, 0.68, 1)`;
                reel.style.top = `-${(stopPositions[index] * 120) + (reelLength + extraSpins - 3) * 120}px`;
                
                // Add a slight bounce effect at the end
                setTimeout(() => {
                    reel.style.transition = 'top 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
                    reel.style.top = `-${(stopPositions[index] * 120) + (reelLength - 3) * 120}px`;
                }, duration * 1000 - 300);
            });
            
            // Check results after all reels have stopped
            setTimeout(() => {
                const visibleSymbols = [];
                
                // Get all visible symbols (3x3 grid)
                for (let reelIndex = 0; reelIndex < 3; reelIndex++) {
                    visibleSymbols[reelIndex] = [];
                    for (let row = 0; row < 3; row++) {
                        const symbolIndex = (stopPositions[reelIndex] + row) % reelLength;
                        visibleSymbols[reelIndex][row] = getSymbolAt(reelIndex, symbolIndex);
                    }
                }
                
                // Check for wins on each active payline
                const paylinePositions = getPaylinePositions(stopPositions);
                let totalWin = 0;
                
                paylinePositions.forEach((positions, lineIndex) => {
                    const lineSymbols = positions.map((pos, reelIndex) => 
                        getSymbolAt(reelIndex, pos)
                    );
                    
                    const win = checkWin(lineSymbols);
                    if (win > 0) {
                        totalWin += win;
                        winningLines.push(lineIndex);
                    }
                });
                
                // Check for bonus
                if (checkForBonus(visibleSymbols)) {
                    setTimeout(() => {
                        activateBonusGame();
                    }, 1000);
                }
                
                // Update UI with win information
                if (totalWin > 0) {
                    credits += totalWin;
                    creditsDisplay.textContent = credits;
                    
                    winMessage.textContent = `WIN ${totalWin} CREDITS!`;
                    winMessage.classList.add('active');
                    
                    // Highlight winning paylines
                    highlightPaylines(winningLines);
                }
                
                spinning = false;
                spinButton.disabled = false;
                
            }, 4500); // Wait for all reels to stop
        }
        
        // Check if a line resulted in a win
        function checkWin(lineSymbols) {
            // Handle wild symbols, only if it's not all wilds
            const hasNonWild = lineSymbols.some(symbol => symbol !== wildSymbol);
            if (!hasNonWild) {
                // All wilds gives a great payout
                return baseBet * 20;
            }
            
            // Replace wilds with the best possible symbol
            if (lineSymbols.includes(wildSymbol)) {
                // Get non-wild symbols
                const nonWildSymbols = lineSymbols.filter(s => s !== wildSymbol);
                
                // If there are multiple different symbols, find the most valuable one
                if (new Set(nonWildSymbols).size === 1) {
                    // Only one type of symbol, replace wilds with it
                    const symbolToReplace = nonWildSymbols[0];
                    lineSymbols = lineSymbols.map(s => s === wildSymbol ? symbolToReplace : s);
                } else if (nonWildSymbols.length > 0) {
                    // Multiple different symbols, find most valuable potential match
                    const symbolCounts = {};
                    nonWildSymbols.forEach(s => {
                        symbolCounts[s] = (symbolCounts[s] || 0) + 1;
                    });
                    
                    let bestSymbol = null;
                    let bestValue = 0;
                    
                    for (const [symbol, count] of Object.entries(symbolCounts)) {
                        const potentialCount = count + (lineSymbols.length - nonWildSymbols.length);
                        const value = getSymbolValue(symbol) * potentialCount;
                        
                        if (value > bestValue) {
                            bestValue = value;
                            bestSymbol = symbol;
                        }
                    }
                    
                    // Replace wilds with best symbol
                    lineSymbols = lineSymbols.map(s => s === wildSymbol ? bestSymbol : s);
                }
            }
            
            // Skip bonus symbols for normal payouts
            if (lineSymbols.includes(bonusSymbol)) {
                return 0;
            }
            
            // Check for three of a kind
            if (lineSymbols[0] === lineSymbols[1] && lineSymbols[1] === lineSymbols[2]) {
                const symbolValue = getSymbolValue(lineSymbols[0]);
                return baseBet * symbolValue;
            }
            
            return 0;
        }
        
        // Get the multiplier value of a symbol
        function getSymbolValue(symbol) {
            switch(symbol) {
                case '7️⃣': return 15;
                case '🍀': return 12;
                case '💎': return 10;
                case '🍉': return 8;
                case '🍊': return 6;
                case '🍇': return 4;
                case '🍋': return 3;
                case '🍒': return 2;
                default: return 0;
            }
        }
        
        // Activate bonus light flashing
        function flashBonusLight() {
            bonusLightActive = true;
            bonusLight.classList.add('active');
            
            setTimeout(() => {
                bonusLightActive = false;
                bonusLight.classList.remove('active');
            }, 10000);
        }
        
        // Activate bonus game
        function activateBonusGame() {
            bonusMode = true;
            flashBonusLight();
            
            // Show bonus game
            bonusGame.classList.add('active');
            
            // Reset choices
            bonusChoices.forEach(choice => {
                choice.textContent = '🎁';
                choice.style.pointerEvents = 'auto';
            });
            
            bonusResult.textContent = '';
            closeBonusButton.style.display = 'none';
        }
        
        // Handle bonus choice
        function handleBonusChoice(e) {
            if (!bonusMode) return;
            
            const choice = e.target;
            const value = parseInt(choice.dataset.value);
            
            // Disable other choices
            bonusChoices.forEach(c => {
                c.style.pointerEvents = 'none';
            });
            
            // Reveal all choices
            const prizes = ['FREE SPINS', 'CREDITS', 'MULTIPLIER'];
            const prizeValues = [
                {text: '5 FREE SPINS', value: 0},
                {text: `${baseBet * 25} CREDITS`, value: baseBet * 25},
                {text: '2X MULTIPLIER', value: credits}
            ];
            
            bonusChoices.forEach((c, i) => {
                // Stagger the reveal
                setTimeout(() => {
                    c.textContent = prizes[i];
                }, i * 500);
            });
            
            // Give the prize for the chosen option
            setTimeout(() => {
                const prize = prizeValues[value - 1];
                bonusResult.textContent = `You won: ${prize.text}!`;
                
                if (value === 1) {
                    // Free spins will be handled when bonus is closed
                } else {
                    // Add credits immediately
                    credits += prize.value;
                    creditsDisplay.textContent = credits;
                }
                
                closeBonusButton.style.display = 'inline-block';
            }, 1500);
        }
        
        // Close bonus game
        function closeBonusGame() {
            bonusMode = false;
            bonusGame.classList.remove('active');
            
            // Check which bonus was won
            if (bonusResult.textContent.includes('FREE SPINS')) {
                // Trigger 5 free spins
                runFreeSpins(5);
            }
        }
        
        // Run free spins
        function runFreeSpins(count) {
            let spinsLeft = count;
            
            function spinNext() {
                if (spinsLeft <= 0) return;
                
                // Show message
                winMessage.textContent = `FREE SPIN! ${spinsLeft} remaining`;
                winMessage.classList.add('active');
                
                // Spin without deducting credits
                const originalCredits = credits;
                spin();
                
                // Make sure credits aren't deducted for free spin
                setTimeout(() => {
                    credits = originalCredits;
                    creditsDisplay.textContent = credits;
                    
                    // Next spin after a delay
                    spinsLeft--;
                    if (spinsLeft > 0) {
                        setTimeout(spinNext, 5000);
                    }
                }, 500);
            }
            
            // Start free spins after a delay
            setTimeout(spinNext, 1000);
        }
        
        // Update bet amount
        function updateBet(change) {
            baseBet = Math.max(1, Math.min(20, baseBet + change));
            betAmountDisplay.textContent = baseBet;
        }
        
        // Set active paylines
        function setPaylines(count) {
            activePaylines = count;
            
            // Update UI
            paylineButtons.forEach(button => {
                const buttonPaylines = parseInt(button.dataset.paylines);
                if (buttonPaylines <= count) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }
        
        // Initialize the game
        function init() {
            initReels();
            
            // Event listeners
            spinButton.addEventListener('click', spin);
            machineHandle.addEventListener('click', function() {
                this.classList.add('pulled');
                setTimeout(() => {
                    this.classList.remove('pulled');
                }, 1000);
                spin();
            });
            
            betDecreaseButton.addEventListener('click', () => updateBet(-1));
            betIncreaseButton.addEventListener('click', () => updateBet(1));
            
            paylineButtons.forEach(button => {
                button.addEventListener('click', () => {
                    setPaylines(parseInt(button.dataset.paylines));
                });
            });
            
            bonusChoices.forEach(choice => {
                choice.addEventListener('click', handleBonusChoice);
            });
            
            closeBonusButton.addEventListener('click', closeBonusGame);
            
            // Debug helper
            window.addCredits = function(amount = 500) {
                credits += amount;
                creditsDisplay.textContent = credits;
            };
            
            // Debug helper to trigger bonus
            window.triggerBonus = function() {
                activateBonusGame();
            };
        }
        
        // Start the game when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>